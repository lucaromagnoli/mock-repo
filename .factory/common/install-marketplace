#!/usr/bin/env bash
set -euo pipefail

# Marketplace installation script
# Installs marketplace agents and skills to .claude/ directory

MARKETPLACE_DIR="${1:-.factory/marketplace}"
MARKETPLACE_DIR=$(realpath "$MARKETPLACE_DIR")

if [ ! -d "$MARKETPLACE_DIR" ]; then
  echo "ERROR: Marketplace directory not found: $MARKETPLACE_DIR"
  exit 1
fi

echo "=== INSTALLING MARKETPLACE ==="
echo "Marketplace directory: $MARKETPLACE_DIR"
echo ""

# Always install to .claude in current working directory
# This ensures marketplace is on the shared PVC, not in container's home
CLAUDE_DIR=".claude"

# Create Claude directory structure
mkdir -p "$CLAUDE_DIR/agents"
mkdir -p "$CLAUDE_DIR/skills"

# Copy agents
AGENTS_DIR="$MARKETPLACE_DIR/agents"
if [ -d "$AGENTS_DIR" ]; then
  echo "Installing agents..."
  cp -r "$AGENTS_DIR"/* "$CLAUDE_DIR/agents/" 2>/dev/null || true
  AGENT_COUNT=$(ls "$CLAUDE_DIR/agents"/*.md 2>/dev/null | wc -l)
  echo "✓ Installed $AGENT_COUNT agents"
else
  echo "⚠ No agents directory found"
fi

# Copy skills
SKILLS_DIR="$MARKETPLACE_DIR/skills"
if [ -d "$SKILLS_DIR" ]; then
  echo "Installing skills..."
  cp -r "$SKILLS_DIR"/* "$CLAUDE_DIR/skills/" 2>/dev/null || true
  SKILL_COUNT=$(ls -d "$CLAUDE_DIR/skills"/*/ 2>/dev/null | wc -l)
  echo "✓ Installed $SKILL_COUNT skills"
else
  echo "⚠ No skills directory found"
fi

echo ""
echo "=== MARKETPLACE INSTALLATION COMPLETE ==="
echo "Agents: $CLAUDE_DIR/agents/"
echo "Skills: $CLAUDE_DIR/skills/"
